<html>
<style>
    #videoObjectHtml5ApiServer {
        width: 854px;
        height: 480px;
        background: #666;
    }
</style>

<body>
    <!-- Создание видео элементов и кнопки начала трансляции -->
    <video autoplay id="videoObjectHtml5ApiServer"></video>
    <button onclick="playvideo()">Запустить видео</button>

    <script type="text/javascript">
        //Переменные плееров
        var video = document.getElementById('videoObjectHtml5ApiServer');
        var sourceBuffer;
        var response;
        var reader = new FileReader();
        var videobuffer = [];

        //Создаем медиаресурс и подключаем его к плееру
        var mediaSource = new MediaSource();
        video.src = URL.createObjectURL(mediaSource);

        //Событие открытия медиаресурса плеера
        mediaSource.addEventListener('sourceopen', sourceOpen);

        var countofbuffer = 1;

        function sourceOpen() {
            //Добавление буффера (определенного типа 'video/webm; codecs=vp8') к mediaSource
            if (countofbuffer == 1) {
                sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs=vp8');
                countofbuffer = 2;
            }

            //Событие окончания добавления данных в буффер
            sourceBuffer.addEventListener("updateend", () => {
                if (mediaSource.readyState == 'open') {
                    mediaSource.endOfStream();
                    video.play();
                };
            });
        };

        let responsinfotext = "false";
        let responseinfo;

        //Функция получения новой информации видео
        async function getvideochunk() {
            response = await fetch('http://localhost:8080/getvideo', { method: 'GET' });

            reader.onload = function (evt) {
                videobuffer.push(evt.target.result);
                sourceBuffer.appendBuffer(videobuffer.pop());
            };

            reader.readAsArrayBuffer(await response.blob());
        }

        //Функция запуска видео. Каждую секунду скачивает новый кусочек. Работает, но есть подвисания
        async function playvideo() {
            // let timercheck = setInterval(async () => {
            //     //await getvideochunk();
            //     responseinfo = await fetch('http://localhost:8080/getinfo', { method: 'GET' })
            //     responsinfotext = await responseinfo.text();
            //     console.log(responsinfotext);
            // }, 500);

            // let timerinfo = setInterval(async () => {
            //     responseinfo = await fetch('http://localhost:8080/getinfo', { method: 'GET' })
            //     if (responsinfotext != await responseinfo.text()) {
            //         await getvideochunk();
            //     }
            // }, 1000);

            let timer = setInterval(async () => {
                await getvideochunk();
            }, 1000);
        };

    </script>
</body>

</html>