<html>
<style>
    #videoObjectHtml5ApiServer {
        width: 854px;
        height: 480px;
        background: #666;
    }
</style>

<body>
    <!-- Создание видео элементов и кнопки начала трансляции -->
    <video autoplay id="videoObjectHtml5ApiServer"></video>
    <button onclick="playvideo()">Запустить видео</button>
    <button onclick="stopvideo()">Остановить видео</button>
    <script type="text/javascript">
        //Переменные плееров
        var video = document.getElementById('videoObjectHtml5ApiServer');
        var sourceBuffer;
        var response;
        var reader = new FileReader();
        var videobuffer = [];
        var tempBuf = [];

        //Создаем медиаресурс и подключаем его к плееру
        var mediaSource = new MediaSource();
        video.src = URL.createObjectURL(mediaSource);

        //Событие открытия медиаресурса плеера
        mediaSource.addEventListener('sourceopen', sourceOpen);

        var countofbuffer = 1;

        function sourceOpen() {
            //Добавление буффера (определенного типа 'video/webm; codecs=vp8') к mediaSource
            if (countofbuffer == 1) {
                sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs=vp8');
                countofbuffer = 2;
            }

            //Событие окончания добавления данных в буффер
            sourceBuffer.addEventListener("updateend", () => {
                if (mediaSource.readyState == 'open') {
                    // mediaSource.endOfStream();
                    video.play();
                };
            });
        };

        let responsinfotext = "false";
        let responseinfo;

        //Функция получения новой информации видео
        async function getvideochunk() {
            response = await fetch('http://localhost:8080/getvideo', { method: 'GET' });

            reader.onload = async function (evt) {
                await tempBuf.push(evt.target.result);
                await sourceBuffer.appendBuffer(tempBuf.pop());
            };

          
            var buf = await response.arrayBuffer
            var d = await response.blob()
            await reader.readAsArrayBuffer(d.slice(0, d.size, 'video/webm'));
            // await sourceBuffer.appendBuffer(buf);
            videobuffer.push(d.slice(0, d.size, 'video/webm'))
            console.log(d.slice(0, d.size, 'video/webm'))

            // videobuffer.push(await response.body)
        }

        //Функция запуска видео. Каждую секунду скачивает новый кусочек. Работает, но есть подвисания
        async function playvideo() {
            // let timercheck = setInterval(async () => {
            //     //await getvideochunk();
            //     responseinfo = await fetch('http://localhost:8080/getinfo', { method: 'GET' })
            //     responsinfotext = await responseinfo.text();
            //     console.log(responsinfotext);
            // }, 500);

            // let timerinfo = setInterval(async () => {
            //     responseinfo = await fetch('http://localhost:8080/getinfo', { method: 'GET' })
            //     if (responsinfotext != await responseinfo.text()) {
            //         await getvideochunk();
            //     }
            // }, 1000);

            let timer = await setInterval(async () => {
                var start = new Date().getTime();

                await getvideochunk();

                var end = new Date().getTime();

                var time = end - start;

                console.log('Время выполнения = ' + time);

            }, 3000);
        };
        function stopvideo() {
            const anchor = document.createElement('a');
            anchor.href = URL.createObjectURL(new Blob(videobuffer, {type : 'video/webm; codecs=vp8'}));
            anchor.download = "video.webm";

            // Append to the DOM
            document.body.appendChild(anchor);

            // Trigger `click` event
            anchor.click();

            // Remove element from DOM
            document.body.removeChild(anchor);
        }

    </script>
</body>

</html>